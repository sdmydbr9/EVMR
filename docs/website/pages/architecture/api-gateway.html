<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Gateway - EVMR Documentation</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="docs-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../../images/logo.svg" alt="EVMR Logo" class="logo">
                <h1>EVMR Docs</h1>
            </div>
            <div class="sidebar-search">
                <input type="text" id="search-input" placeholder="Search documentation...">
                <i class="fas fa-search search-icon"></i>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-section">
                        <span class="section-title">Getting Started</span>
                        <ul>
                            <li><a href="../../index.html">Introduction</a></li>
                            <li><a href="../quickstart.html">Quick Start Guide</a></li>
                            <li><a href="../installation.html">Installation</a></li>
                        </ul>
                    </li>
                    <li class="nav-section">
                        <span class="section-title">Architecture</span>
                        <ul>
                            <li><a href="overview.html">System Overview</a></li>
                            <li><a href="microservices.html">Microservices</a></li>
                            <li><a href="database.html">Database Schema</a></li>
                            <li><a href="frontend.html">Frontend Structure</a></li>
                            <li><a href="api-gateway.html" class="active">API Gateway</a></li>
                        </ul>
                    </li>
                    <li class="nav-section">
                        <span class="section-title">Microservices</span>
                        <ul>
                            <li><a href="../microservices/auth-service.html">Auth Service</a></li>
                            <li><a href="../microservices/patient-service.html">Patient Service</a></li>
                            <li><a href="../microservices/appointment-service.html">Appointment Service</a></li>
                            <li><a href="../microservices/inventory-service.html">Inventory Service</a></li>
                            <li><a href="../microservices/reporting-service.html">Reporting Service</a></li>
                            <li><a href="../microservices/notification-service.html">Notification Service</a></li>
                        </ul>
                    </li>
                    <li class="nav-section">
                        <span class="section-title">API Reference</span>
                        <ul>
                            <li><a href="../api/authentication.html">Authentication</a></li>
                            <li><a href="../api/patients.html">Patients</a></li>
                            <li><a href="../api/medical-records.html">Medical Records</a></li>
                            <li><a href="../api/appointments.html">Appointments</a></li>
                            <li><a href="../api/inventory.html">Inventory</a></li>
                            <li><a href="../api/reports.html">Reports</a></li>
                        </ul>
                    </li>
                    <li class="nav-section">
                        <span class="section-title">Deployment</span>
                        <ul>
                            <li><a href="../deployment/docker.html">Docker Deployment</a></li>
                            <li><a href="../deployment/configuration.html">Configuration</a></li>
                            <li><a href="../deployment/scaling.html">Scaling</a></li>
                            <li><a href="../deployment/monitoring.html">Monitoring</a></li>
                        </ul>
                    </li>
                    <li class="nav-section">
                        <span class="section-title">Guides</span>
                        <ul>
                            <li><a href="../guides/user-management.html">User Management</a></li>
                            <li><a href="../guides/patient-records.html">Patient Records</a></li>
                            <li><a href="../guides/appointments.html">Appointments</a></li>
                            <li><a href="../guides/reporting.html">Reporting</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="https://github.com/yourusername/EVMR" target="_blank">
                    <i class="fab fa-github"></i> GitHub
                </a>
                <a href="../contributing.html">
                    <i class="fas fa-code-branch"></i> Contributing
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <div class="content-header">
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-links">
                    <a href="https://github.com/yourusername/EVMR" target="_blank">
                        <i class="fab fa-github"></i>
                    </a>
                    <a href="#" id="theme-toggle">
                        <i class="fas fa-moon"></i>
                    </a>
                </div>
            </div>

            <div class="content-body">
                <h1>API Gateway</h1>
                <p class="lead">
                    The API Gateway serves as the single entry point for all client requests, routing them to the appropriate microservices and handling cross-cutting concerns.
                </p>

                <nav class="page-toc">
                    <h3>On this page</h3>
                    <ul>
                        <li><a href="#overview">Overview</a></li>
                        <li><a href="#architecture">Architecture</a></li>
                        <li><a href="#key-features">Key Features</a></li>
                        <li><a href="#request-flow">Request Flow</a></li>
                        <li><a href="#routing">Request Routing</a></li>
                        <li><a href="#authentication">Authentication and Authorization</a></li>
                        <li><a href="#rate-limiting">Rate Limiting</a></li>
                        <li><a href="#request-transformation">Request/Response Transformation</a></li>
                        <li><a href="#error-handling">Error Handling</a></li>
                        <li><a href="#logging-monitoring">Logging and Monitoring</a></li>
                        <li><a href="#configuration">Configuration</a></li>
                        <li><a href="#deployment">Deployment</a></li>
                    </ul>
                </nav>

                <h2 id="overview">Overview</h2>
                <p>
                    The API Gateway is a critical component in the EVMR microservices architecture, serving as the single entry point for all client requests. It routes requests to the appropriate microservices, handles cross-cutting concerns like authentication and rate limiting, and provides a unified API for the frontend application.
                </p>

                <div class="api-gateway-diagram">
                    <img src="../../images/api-gateway-architecture.png" alt="EVMR API Gateway Architecture">
                    <p class="diagram-caption">Figure 1: API Gateway architecture showing request routing and cross-cutting concerns</p>
                </div>

                <div class="info-box">
                    <h3>Gateway Details</h3>
                    <ul>
                        <li><strong>Port:</strong> 3786</li>
                        <li><strong>Base URL:</strong> <code>http://localhost:3786</code> (development)</li>
                        <li><strong>Technologies:</strong> Node.js, Express, Redis</li>
                        <li><strong>Dependencies:</strong> All microservices</li>
                    </ul>
                </div>

                <h2 id="architecture">Architecture</h2>
                <p>
                    The API Gateway follows a layered architecture pattern:
                </p>

                <ul>
                    <li><strong>Routing Layer:</strong> Routes requests to the appropriate microservices</li>
                    <li><strong>Middleware Layer:</strong> Handles cross-cutting concerns like authentication, rate limiting, and logging</li>
                    <li><strong>Transformation Layer:</strong> Transforms requests and responses as needed</li>
                    <li><strong>Integration Layer:</strong> Communicates with microservices</li>
                    <li><strong>Error Handling Layer:</strong> Provides consistent error responses</li>
                </ul>

                <h2 id="key-features">Key Features</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-route"></i>
                        </div>
                        <h3>Request Routing</h3>
                        <p>Routes requests to appropriate microservices</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Authentication</h3>
                        <p>Validates JWT tokens and enforces authentication</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-user-lock"></i>
                        </div>
                        <h3>Authorization</h3>
                        <p>Enforces role-based access control</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <h3>Rate Limiting</h3>
                        <p>Prevents abuse through request rate limiting</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <h3>Request Transformation</h3>
                        <p>Transforms requests and responses as needed</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <h3>Error Handling</h3>
                        <p>Provides consistent error responses</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h3>Logging</h3>
                        <p>Comprehensive request and error logging</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Monitoring</h3>
                        <p>Performance and health monitoring</p>
                    </div>
                </div>

                <h2 id="request-flow">Request Flow</h2>
                <p>
                    The following diagram illustrates the flow of a request through the API Gateway:
                </p>

                <div class="request-flow-diagram">
                    <img src="../../images/api-gateway-flow.png" alt="EVMR API Gateway Request Flow">
                    <p class="diagram-caption">Figure 2: Request flow through the API Gateway</p>
                </div>

                <ol>
                    <li>Client sends a request to the API Gateway</li>
                    <li>Request passes through middleware layers (logging, authentication, rate limiting)</li>
                    <li>API Gateway determines the target microservice based on the request path</li>
                    <li>Request is transformed if necessary</li>
                    <li>API Gateway forwards the request to the appropriate microservice</li>
                    <li>Microservice processes the request and returns a response</li>
                    <li>Response is transformed if necessary</li>
                    <li>API Gateway returns the response to the client</li>
                </ol>

                <h2 id="routing">Request Routing</h2>
                <p>
                    The API Gateway routes requests to the appropriate microservices based on the request path:
                </p>

                <div class="code-block">
                    <pre><code>// Example routing configuration
const express = require('express');
const { createProxyMiddleware } = require('http-proxy-middleware');

const app = express();

// Auth Service Routes
app.use('/api/auth', createProxyMiddleware({
  target: process.env.AUTH_SERVICE_URL,
  changeOrigin: true,
  pathRewrite: {
    '^/api/auth': '/api/auth'
  }
}));

// Patient Service Routes
app.use('/api/patients', createProxyMiddleware({
  target: process.env.PATIENT_SERVICE_URL,
  changeOrigin: true,
  pathRewrite: {
    '^/api/patients': '/api/patients'
  }
}));

app.use('/api/medical-records', createProxyMiddleware({
  target: process.env.PATIENT_SERVICE_URL,
  changeOrigin: true,
  pathRewrite: {
    '^/api/medical-records': '/api/medical-records'
  }
}));

// Appointment Service Routes
app.use('/api/appointments', createProxyMiddleware({
  target: process.env.APPOINTMENT_SERVICE_URL,
  changeOrigin: true,
  pathRewrite: {
    '^/api/appointments': '/api/appointments'
  }
}));

// Inventory Service Routes
app.use('/api/inventory', createProxyMiddleware({
  target: process.env.INVENTORY_SERVICE_URL,
  changeOrigin: true,
  pathRewrite: {
    '^/api/inventory': '/api/inventory'
  }
}));

// Reporting Service Routes
app.use('/api/reports', createProxyMiddleware({
  target: process.env.REPORTING_SERVICE_URL,
  changeOrigin: true,
  pathRewrite: {
    '^/api/reports': '/api/reports'
  }
}));

// Notification Service Routes
app.use('/api/notifications', createProxyMiddleware({
  target: process.env.NOTIFICATION_SERVICE_URL,
  changeOrigin: true,
  pathRewrite: {
    '^/api/notifications': '/api/notifications'
  }
}));</code></pre>
                </div>

                <h2 id="authentication">Authentication and Authorization</h2>
                <p>
                    The API Gateway handles authentication and authorization for all incoming requests:
                </p>

                <div class="code-block">
                    <pre><code>// Authentication middleware
const authenticateJWT = async (req, res, next) => {
  try {
    const token = req.header('Authorization')?.replace('Bearer ', '');
    
    if (!token) {
      return res.status(401).json({ error: 'Authentication required' });
    }
    
    // Validate token with Auth Service
    const response = await axios.get(`${process.env.AUTH_SERVICE_URL}/api/auth/verify`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    req.user = response.data.user;
    next();
  } catch (error) {
    res.status(401).json({ error: 'Invalid token' });
  }
};

// Role-based authorization middleware
const authorize = (roles) => {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ error: 'Authentication required' });
    }
    
    if (roles.includes(req.user.role)) {
      next();
    } else {
      res.status(403).json({ error: 'Insufficient permissions' });
    }
  };
};</code></pre>
                </div>

                <h3>Protected Routes</h3>
                <p>
                    Most routes in the API Gateway are protected by the authentication middleware, with exceptions for public routes like login and registration:
                </p>

                <div class="code-block">
                    <pre><code>// Public routes (no authentication required)
app.use('/api/auth/login', createProxyMiddleware({ target: process.env.AUTH_SERVICE_URL, changeOrigin: true }));
app.use('/api/auth/register', createProxyMiddleware({ target: process.env.AUTH_SERVICE_URL, changeOrigin: true }));
app.use('/api/auth/forgot-password', createProxyMiddleware({ target: process.env.AUTH_SERVICE_URL, changeOrigin: true }));
app.use('/api/auth/reset-password', createProxyMiddleware({ target: process.env.AUTH_SERVICE_URL, changeOrigin: true }));

// Protected routes (authentication required)
app.use('/api/patients', authenticateJWT, createProxyMiddleware({ target: process.env.PATIENT_SERVICE_URL, changeOrigin: true }));
app.use('/api/appointments', authenticateJWT, createProxyMiddleware({ target: process.env.APPOINTMENT_SERVICE_URL, changeOrigin: true }));
app.use('/api/inventory', authenticateJWT, createProxyMiddleware({ target: process.env.INVENTORY_SERVICE_URL, changeOrigin: true }));
app.use('/api/reports', authenticateJWT, createProxyMiddleware({ target: process.env.REPORTING_SERVICE_URL, changeOrigin: true }));
app.use('/api/notifications', authenticateJWT, createProxyMiddleware({ target: process.env.NOTIFICATION_SERVICE_URL, changeOrigin: true }));</code></pre>
                </div>

                <h2 id="rate-limiting">Rate Limiting</h2>
                <p>
                    The API Gateway implements rate limiting to prevent abuse and ensure fair usage of the API:
                </p>

                <div class="code-block">
                    <pre><code>const rateLimit = require('express-rate-limit');
const RedisStore = require('rate-limit-redis');
const redis = require('redis');

const redisClient = redis.createClient({
  host: process.env.REDIS_HOST,
  port: process.env.REDIS_PORT
});

// Basic rate limiting for all routes
const apiLimiter = rateLimit({
  store: new RedisStore({
    client: redisClient,
    prefix: 'rate-limit:'
  }),
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
  message: {
    error: 'Too many requests, please try again later.'
  }
});

// More strict rate limiting for authentication routes
const authLimiter = rateLimit({
  store: new RedisStore({
    client: redisClient,
    prefix: 'auth-rate-limit:'
  }),
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 10, // limit each IP to 10 requests per windowMs
  message: {
    error: 'Too many authentication attempts, please try again later.'
  }
});

// Apply rate limiting
app.use('/api', apiLimiter);
app.use('/api/auth/login', authLimiter);
app.use('/api/auth/register', authLimiter);</code></pre>
                </div>

                <h2 id="request-transformation">Request/Response Transformation</h2>
                <p>
                    The API Gateway can transform requests and responses as needed to provide a consistent API to clients:
                </p>

                <div class="code-block">
                    <pre><code>// Example request transformation middleware
const transformRequest = (req, res, next) => {
  // Add organization ID to request based on authenticated user
  if (req.user && req.user.organizationId) {
    req.headers['X-Organization-ID'] = req.user.organizationId;
  }
  
  next();
};

// Example response transformation middleware
const transformResponse = (proxyRes, req, res) => {
  // Modify response data if needed
  const originalBody = proxyRes.body;
  
  // Example: Add links for pagination
  if (originalBody.data && originalBody.pagination) {
    const baseUrl = `${req.protocol}://${req.get('host')}${req.originalUrl.split('?')[0]}`;
    const { page, limit, total } = originalBody.pagination;
    
    originalBody._links = {
      self: `${baseUrl}?page=${page}&limit=${limit}`,
      first: `${baseUrl}?page=1&limit=${limit}`,
      last: `${baseUrl}?page=${Math.ceil(total / limit)}&limit=${limit}`
    };
    
    if (page > 1) {
      originalBody._links.prev = `${baseUrl}?page=${page - 1}&limit=${limit}`;
    }
    
    if (page < Math.ceil(total / limit)) {
      originalBody._links.next = `${baseUrl}?page=${page + 1}&limit=${limit}`;
    }
  }
  
  return originalBody;
};</code></pre>
                </div>

                <h2 id="error-handling">Error Handling</h2>
                <p>
                    The API Gateway provides consistent error handling for all responses:
                </p>

                <div class="code-block">
                    <pre><code>// Global error handling middleware
app.use((err, req, res, next) => {
  console.error('API Gateway Error:', err);
  
  // Determine status code
  const statusCode = err.statusCode || err.status || 500;
  
  // Format error response
  const errorResponse = {
    error: true,
    message: err.message || 'Internal Server Error',
    code: err.code || 'INTERNAL_ERROR'
  };
  
  // Add stack trace in development
  if (process.env.NODE_ENV === 'development' && err.stack) {
    errorResponse.stack = err.stack;
  }
  
  res.status(statusCode).json(errorResponse);
});

// Handle 404 errors
app.use((req, res) => {
  res.status(404).json({
    error: true,
    message: 'Resource not found',
    code: 'NOT_FOUND'
  });
});</code></pre>
                </div>

                <h2 id="logging-monitoring">Logging and Monitoring</h2>
                <p>
                    The API Gateway implements comprehensive logging and monitoring:
                </p>

                <div class="code-block">
                    <pre><code>const morgan = require('morgan');
const winston = require('winston');

// Configure logger
const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

// Add console transport in development
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.combine(
      winston.format.colorize(),
      winston.format.simple()
    )
  }));
}

// Request logging middleware
app.use(morgan('combined', {
  stream: {
    write: (message) => logger.info(message.trim())
  }
}));

// Health check endpoint
app.get('/health', (req, res) => {
  res.status(200).json({
    status: 'UP',
    timestamp: new Date().toISOString(),
    services: {
      auth: { status: 'UP' },
      patient: { status: 'UP' },
      appointment: { status: 'UP' },
      inventory: { status: 'UP' },
      reporting: { status: 'UP' },
      notification: { status: 'UP' }
    }
  });
});</code></pre>
                </div>

                <h2 id="configuration">Configuration</h2>
                <p>
                    The API Gateway is configured using environment variables:
                </p>

                <div class="code-block">
                    <pre><code># Server Configuration
PORT=3786
NODE_ENV=development

# Microservice URLs
AUTH_SERVICE_URL=http://auth-service:5101
PATIENT_SERVICE_URL=http://patient-service:5102
APPOINTMENT_SERVICE_URL=http://appointment-service:5103
INVENTORY_SERVICE_URL=http://inventory-service:5104
REPORTING_SERVICE_URL=http://reporting-service:5105
NOTIFICATION_SERVICE_URL=http://notification-service:5106

# Redis Configuration (for rate limiting and caching)
REDIS_HOST=redis
REDIS_PORT=7529

# JWT Configuration
JWT_SECRET=your_jwt_secret_key

# Logging
LOG_LEVEL=info

# CORS Configuration
CORS_ORIGIN=http://localhost:3000

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX=100
AUTH_RATE_LIMIT_MAX=10</code></pre>
                </div>

                <h2 id="deployment">Deployment</h2>
                <p>
                    The API Gateway is deployed as a Docker container as part of the EVMR microservices architecture:
                </p>

                <div class="code-block">
                    <pre><code># From docker-compose.yml
petsphere-app:
  build:
    context: .
    dockerfile: Dockerfile
  container_name: petsphere-application
  restart: unless-stopped
  ports:
    - "3786:3786" # Map container port to host port
  depends_on:
    petsphere-db: # Ensure database is started before the application
      condition: service_healthy
    auth-service:
      condition: service_healthy
    patient-service:
      condition: service_healthy
    appointment-service:
      condition: service_healthy
  environment:
    # Application configuration
    - NODE_ENV=${NODE_ENV}
    - PORT=${PORT}
    - APP_NAME=${APP_NAME}
    # Database connection
    - DATABASE_URL=postgresql://${POSTGRES_USER}:${DB_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
    # Authentication
    - JWT_SECRET=${JWT_SECRET}
    - JWT_EXPIRATION=${JWT_EXPIRATION}
    # Redis configuration
    - REDIS_HOST=redis
    - REDIS_PORT=7529
    # Demo configuration
    - ORG_DEMO_ID=ORG12345
    # Auth service configuration
    - AUTH_SERVICE_URL=http://auth-service:5101
    # Patient service configuration
    - PATIENT_SERVICE_URL=http://patient-service:5102
    # Appointment service configuration
    - APPOINTMENT_SERVICE_URL=http://appointment-service:5103
  env_file:
    - .env # Load additional environment variables from .env file
  volumes:
    # Mount for persistent storage of uploaded files (lab results, x-rays, etc.)
    - petsphere-uploads:/app/backend/uploads
    # Mount for logs
    - petsphere-logs:/app/backend/logs
  networks:
    - petsphere-network
  # Healthcheck for application
  healthcheck:
    test: ["CMD", "wget", "-qO-", "http://localhost:3786/health"]
    interval: 30s
    timeout: 5s
    retries: 3
    start_period: 30s</code></pre>
                </div>

                <div class="next-section">
                    <h3>Next Steps</h3>
                    <p>Now that you understand the API Gateway, you can explore:</p>
                    <ul>
                        <li><a href="../api/authentication.html">Authentication API Reference</a></li>
                        <li><a href="../deployment/docker.html">Docker Deployment Guide</a></li>
                        <li><a href="../deployment/configuration.html">Configuration Guide</a></li>
                    </ul>
                </div>
            </div>

            <footer class="content-footer">
                <p>&copy; 2023 EVMR Documentation. All rights reserved.</p>
                <p>
                    <a href="../privacy.html">Privacy Policy</a> |
                    <a href="../terms.html">Terms of Service</a> |
                    <a href="../contact.html">Contact</a>
                </p>
            </footer>
        </main>
    </div>

    <script src="../../js/main.js"></script>
</body>
</html>
